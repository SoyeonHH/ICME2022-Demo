<!DOCTYPE html>
<html>
  <meta charset="utf-8">
  <head>
    <link rel="stylesheet" href="/style/common.css" type="text/css">
    <link rel="stylesheet" href="./style/analysis.css" type="text/css">
  </head>
  <body>
    <div class="header">
      <a href="http://210.107.197.59"><div class="header-leading">
        DeMuSA
      </div></a>
      <div class="header-action">
        <a href="http://210.107.197.59"><div class="header-item analysis selected">Analyzer</div></a>
        <a href="http://210.107.197.59/explorer"><div class="header-item view">Data Explorer</div></a>
        <div class="header-github"><a href="https://github.com/SoyeonHH/ICME2022-Demo"><img src="./image/github.png" style="filter: invert(100%);"/></a></div>
      </div>
    </div>

    <div class="section">
      <h1>Analyzer</h1>
      <div id="workspace">
        <h2>Upload Your Results</h2>
        <div style="height: 24px;"></div>
        <div id="upload-table-wrapper">
          <table id = "upload-table">
            <tr>
              <td>Model Name</td>
              <td colspan="2" width="60%"><input type="text" id="inputModelName" style="width:100%"/></td>
            </tr>
            <tr>
              <td>Dataset</td>
              <td width="30%"><input type="radio" name="MOSI" id="radio-mosi" checked="true"/>MOSI</td>
              <td width="30%"><input type="radio" name="MOSEI" id="radio-mosei"/>MOSEI</td>
            </tr>
            <tr>
              <td>result csv file</td>
              <td colspan="2" width="60%">
                <input type="file" id="inputModelFile" accept=".csv"></input>
                <button type="button" id="uploadButton">upload</button>
              </td>
            </tr>
          </table>
          <div id="upload-description">
            <img src="./image/upload_file_example2.png" />
          </div>
          <div class="descript" style="color: #878787; text-align: center;">
            Input your predict result file that has above csv format !
          </div>
        </div>
        <div style="height: 24px;"></div>
        <div id="download-set">
          <div>
            <a id="link1" onmouseover="mouseOver1()" onmouseout="mouseOut()" href="./data/mosi.pkl" style="font-family: Anek Tamil;" download>
            Download cmu_mosi.pkl</a>
          </div>
          <div>
            <a id="link2" onmouseover="mouseOver2()" onmouseout="mouseOut()" href="./data/mosei.pkl" style="font-family: Anek Tamil;" download>
            Download cmu_mosei.pkl</a>
          </div>
          <div>
            <a id="link3" onmouseover="mouseOver3()" onmouseout="mouseOut()" href="./data/example_mosi.csv" style="font-family: Anek Tamil;" download>
            Download example_mosi.csv</a>
          </div>
          <div>
            <a id="link4" onmouseover="mouseOver4()" onmouseout="mouseOut()" href="./data/example_mosei.csv" style="font-family: Anek Tamil;" download>
            Download example_mosei.csv</a>
          </div>
          <script>
            function mouseOver1(){
              document.getElementById("link1").style.color = "rgb(255, 99, 132)"
            }

            function mouseOver2(){
              document.getElementById("link2").style.color = "rgb(255, 99, 132)";
            }

            function mouseOver3(){
              document.getElementById("link3").style.color = "rgb(255, 99, 132)";
            }

            function mouseOver4(){
              document.getElementById("link4").style.color = "rgb(255, 99, 132)";
            }

            function mouseOut(){
              document.getElementById("link1").style.color = "black";
              document.getElementById("link2").style.color = "black";
              document.getElementById("link3").style.color = "black";
              document.getElementById("link4").style.color = "black";
            }

          </script>
        </div>
        <div style="height: 8px;"></div>
        <h2>Scoreboard</h2>
        <div class="descript">
          Click the model name that you want to analysis in Scoreboard, and enjoy the observation below !
        </div>
        <table id="scoreboard">
          <tr>
            <td class="scoreboard-left">CMU-MOSI</td>
            <td class="scoreboard-right">CMU-MOSEI</td>
          </tr>
          <tr>
            <td class='scoreboard-left'>
              <div id='mosi-table'>
                <table>
                  <tr>
                    <td>Model</td>
                    <td>MAE (↓)</td>
                    <td>Corr (↑)</td>
                    <td>Acc-2 (↑)</td>
                    <td>Acc-7 (↑)</td>
                    <td>F1 (↑)</td>
                  </tr>
                </table>
              </div>
            </td>
            <td class='scoreboard-right'>
              <div id='mosei-table'>
                <table>
                  <tr>
                    <td>Model</td>
                    <td>MAE (↓)</td>
                    <td>Corr (↑)</td>
                    <td>Acc-2 (↑)</td>
                    <td>Acc-7 (↑)</td>
                    <td>F1 (↑)</td>
                  </tr>
                </table>
              </div>
            </td>
          </tr>
        </table>
      </div>
      <div id="barGraph">
        <h2>Predict Results Distribution</h2>
        <div class="descript">
          You can compare the distributions between gold dataset classes and model prediction result classes !
        </div>
        <div id="canvasList">
          <div class='canvasHolder'><canvas class="graph" id='graph_class_2'></canvas></div>
          <div class='canvasHolder'><canvas class="graph" id='graph_class_7'></canvas></div>
        </div>
      </div>
      <div id="p-barVideos">
        <h2>Video Accuracy</h2>
        <div class="descript">
          If you click the video id, you can observe utterance-level prediction results below !
        </div>
        <table id="videoAcc">
          <tr id="vidName_vidAcc">
            <td></td>
          </tr>
          <tr>
            <td>2 Class</td>
          </tr>
          <tr>
            <td>7 Class</td>
          </tr>
        </table>
      </div>
      <div id="plotComparison">
        <h2>Utterance-level Comparison</h2>
        <div id="segmentVidName" class="descript">no video selected</div>
        <div class="selectWrapper analysis-selectWrapper" id="selectWrapper"></div>
      </div>


      <div id="p-barSengment">
        <h2>Segment Hit</h2>
        <table id="segmentAcc">
          <tr id="segName_segAcc">
            <td></td>
          </tr>
          <tr>
            <td>2 Class</td>
          </tr>
          <tr>
            <td>7 Class</td>
          </tr>
        </table>
      </div>
      <div id="plotSegment">
        <h2>Plot Segment</h2>
        <div id=plotHolder>
          <canvas class='plot' id='scatter0'></canvas>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="footer-content">
        <div class="footer-title">
          Demo for Multimodal Sentiment Analysis
        </div>
        <div class="footer-info">
          <div><a href="https://sites.google.com/view/iknow-lab">
            <svg xmlns="http://www.w3.org/2000/svg" width="10px" height="10px" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 9v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9"/><path d="M9 22V12h6v10M2 10.6L12 2l10 8.6"/></svg>iKnow Lab Ajou Univ.
          </a></div>
          <div>&copy; Soyeon.H</div>
          <div><a href="mailto:sodus1102@ajou.ac.kr">
            <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width='10px' height='10px'><path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z"/></svg>sodus1102 at ajou.ac.kr
          </a></div>
        </div>
      </div>
    </div>


    <div id = "MAG_BERT_TEXT" type='text' src="./predict/MAG-BERT_mosi_result">
    <div id = "MISA_TEXT" type='text' src="./predict/MISA_mosi_result">
    <script type="text/javascript" src="./script/csv.js"></script>
    <script type="text/javascript" src="./script/scoreboard.js"></script>
    <script type="text/javascript" src="./script/chart.js-3.7.1/package/dist/chart.js"></script>
    <script>
  const labels2class = [
    'Negative',
    'Positive'
  ];
  const labels7class = [
    "Very Negative",
    "Negative",
    "Slightly Negative",
    "Neutral",
    "Slightly Positive",
    "Positive",
    "Very Positive",
  ];

  const config = {
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          suggestedMax: 100
        }
      }
    },
  };

  function jsonToResult(jsonFile, goldYes=false) {
    var returnResult = []
    for(let i = 0; i < jsonFile.length; i++) {
      if(goldYes) {
        returnResult.push([jsonFile[i]['Video_id'], parseInt(jsonFile[i]['Segment_id']),parseFloat(jsonFile[i]['Label']), jsonFile[i]['Label_binary'], jsonFile[i]['Label_7']])}
      else {
        returnResult.push([jsonFile[i]['Video_id'], parseInt(jsonFile[i]['Segment_id']),parseFloat(jsonFile[i]['Pred']), jsonFile[i]['Pred_binary'], jsonFile[i]['Pred_7']])}
      if(typeof(jsonFile[i]['Video_id']) == 'undefined' || jsonFile[i]['Video_id'] =="" ) {
        console.log("found undefined!")
        returnResult.pop()
      }
    }
    return returnResult
  }

  // load Global Gold Data
  var globalGold_mosei, globalGold_mosi

  function Model(modelName, datasetType, result) {
    this.modelName = modelName
    this.datasetType = datasetType
    this.publisher = ""
    this.result = result //result on every segment

    this.searchSegment = function(video_id, segment_id) {//return a line of result
      for(let i = 0; i < this.result.length; i++) {
        if(this.result[i][0] == video_id && this.result[i][1] == segment_id) {
          return this.result[i]
        }
      }
      return [false]
    }
    //if found return line of result ex) [video_id,segment_id,Pred, ...]
    //if not found return [false]


    this.getClassPop = function() {//return class accuracy from model's result file

      let classPopulation = [[],[]] //[[gold2class, pred2class], [gold7class, pred2class]]

      let j,k,l,m = -1
      let goldResult
      if(this.datasetType == "mosi") {
        goldResult = globalGold_mosi
      } else if (this.datasetType == "mosei") {
        goldResult = globalGold_mosei
      }

      if(this.result) {//result exist.
        //2 class result
        var gold2class = [0,0]
        var pred2class = [0,0]

        var gold7class = [0,0,0,0,0,0,0]
        var pred7class = [0,0,0,0,0,0,0]

        for (let s = 0; s < this.result.length; s++) {
          let goldLine = goldResult[s]
          let resultline = this.result[s]
          switch(goldLine[3]) {
            case 'negative'         : j = 0; break;
            case 'positive'         : j = 1; break;
            default : j = -1; break; //err uknown class
          }
          gold2class[j] = gold2class[j] + 1

          switch(resultline[3]) {
            case 'negative'         : k = 0; break;
            case 'positive'         : k = 1; break;
            default : k = -1; break; //err uknown class
          }
          pred2class[k] = pred2class[k] + 1

          switch(goldLine[4]) {
            case 'very negative'    : l = 0; break;
            case 'negative'         : l = 1; break;
            case 'slightly negative': l = 2; break;
            case 'Neutral'          : l = 3; break;
            case 'slightly positive': l = 4; break;
            case 'positive'         : l = 5; break;
            case 'very positive'    : l = 6; break;
            default : l = -1; break; //err uknown class
          }
          gold7class[l] = gold7class[l] + 1;

          switch(resultline[4]) {
            case 'very negative'    : m = 0; break;
            case 'negative'         : m = 1; break;
            case 'slightly negative': m = 2; break;
            case 'Neutral'          : m = 3; break;
            case 'slightly positive': m = 4; break;
            case 'positive'         : m = 5; break;
            case 'very positive'    : m = 6; break;
            default : m = -1; break; //err uknown class
          }
          pred7class[m] = pred7class[m] + 1;

        }


        classPopulation[0].push(gold2class)
        classPopulation[0].push(pred2class)
        classPopulation[1].push(gold7class)
        classPopulation[1].push(pred7class)
      }

      return classPopulation
    }
    //return [[gold2class, pred2class], [gold7class, pred7class]]
    //returnAcc2, list ofaccuracy of each 2 classes
    //returnAcc7, list ofaccuracy of each 7 classes

    this.getVideoAcc = function() {//return video accuracy from model's result file
      var vidName = []

      var cntVid2 = []
      var hitVid2 = []
      var cntVid7 = []
      var hitVid7 = []

      var accVid2 = []
      var accVid7 = []

      let goldResult
      if(this.datasetType == "mosi") {
        goldResult = globalGold_mosi
      } else if (this.datasetType == "mosei") {
        goldResult = globalGold_mosei
      }

      if(this.result) {//when result exist count cnt and hit via video
        var tempVidName = ''
        var index = 0
        var saveIndex = 0

        tempVidName = this.result[index][0]
        vidName.push(tempVidName)
        cntVid2.push(0)
        hitVid2.push(0)
        cntVid7.push(0)
        hitVid7.push(0)

        for(let i = 0; i < this.result.length; i++) {
          if(vidName[saveIndex] != this.result[i][0]) {//new video name
            saveIndex = saveIndex + 1
            vidName.push(this.result[i][0])
            cntVid2.push(0)
            hitVid2.push(0)
            cntVid7.push(0)
            hitVid7.push(0)
          }

          cntVid2[saveIndex] = cntVid2[saveIndex] + 1
          cntVid7[saveIndex] = cntVid7[saveIndex] + 1

          if(this.result[i][3] == goldResult[i][3]) {
            hitVid2[saveIndex] = hitVid2[saveIndex] + 1
          }
          if(this.result[i][4] == goldResult[i][4]) {
            hitVid7[saveIndex] = hitVid7[saveIndex] + 1
          }
        }
      }

      for(let i = 0; i < cntVid2.length; i++) {//calculate acc via video with hit and cnt
        accVid2.push(hitVid2[i]/cntVid2[i]*100)
        accVid7.push(hitVid7[i]/cntVid7[i]*100)
      }

      var returning = []
      for(let i = 0; i < cntVid2.length; i++) {
        returning.push([vidName[i],accVid2[i],accVid7[i]])
      }
      return returning
    }
    //return [vidName, accVid2, accVid7]
    //vidName, list of video_id
    //accVid2, list ofaccuracy of video in 2 class
    //accVid7, list ofaccuracy of video in 7 class

    this.getSegmentAcc = function(videoId) {//return hit map of single segmentAcc
      var hitMap2 = []
      var hitMap7 = []

      let goldResult
      if(this.datasetType == "mosi") {
        goldResult = globalGold_mosi
      } else if (this.datasetType == "mosei") {
        goldResult = globalGold_mosei
      }

      if(this.result) {
        for(let i = 0; i < this.result.length; i++) {
          //console.log(videoId)
          //console.log(this.result[i][0])
          if(this.result[i][0] == videoId) {//the correct video id
            if(this.result[i][3] == goldResult[i][3]) {//hit in 2 class
              hitMap2.push(1)
            } else hitMap2.push(0) //miss in 2 class

            if(this.result[i][4] == goldResult[i][4]) {//hit in 7 class
              hitMap7.push(1)
            } else hitMap7.push(0) //miss in 7 class
          }
        }
      }
      return [hitMap2, hitMap7]
    }
    //return [hitMap2, hitMap7]
    //hitMap2, linear Hit map of video in 2 class
    //hitMap2, linear Hit map of video in 7 class

    this.calMAE = function() {
      var sumErr = 0.0

      let goldResult
      if(this.datasetType == "mosi") {
        goldResult = globalGold_mosi
      } else if (this.datasetType == "mosei") {
        goldResult = globalGold_mosei
      }

      for(let i = 0; i< this.result.length; i++) { // | predi - labeli |
        if(this.result[i][2])
        var err = this.result[i][2] - goldResult[i][2]
        if(err > 0 ){
          sumErr = sumErr + err
        } else {
          sumErr = sumErr - err
        }
      }

      if(this.result.length > 0) {
        return (sumErr / this.result.length).toFixed(2)
      } else {
        return -1
      }
    }
    //return MAE

    this.calCorr = function() {
      var meanLabel = 0
      var meanPredi = 0
      var multSum = 0

      let goldResult
      if(this.datasetType == "mosi") {
        goldResult = globalGold_mosi
      } else if (this.datasetType == "mosei") {
        goldResult = globalGold_mosei
      }

      for(let i = 0; i < this.result.length; i++) {
        meanLabel = meanLabel + goldResult[i][2]
        meanPredi = meanPredi + this.result[i][2]
      }

      meanLabel = meanLabel / this.result.length
      meanPredi = meanPredi / this.result.length
      //console.log(meanLabel)
      //console.log(meanPredi)

      for (let i = 0; i < this.result.length; i++) {
        multSum = multSum + (goldResult[i][2] - meanLabel)* (this.result[i][2] - meanPredi)
      }
      //console.log(multSum)

      var labelDivSum = 0
      for (let i = 0; i < this.result.length; i++) {
        labelDivSum = labelDivSum + ((goldResult[i][2] - meanLabel)*(goldResult[i][2] - meanLabel))
      }
      //console.log(labelDivSum)

      var prediDivSum = 0
      for (let i = 0; i < this.result.length; i++) {
        prediDivSum = prediDivSum + ((this.result[i][2] - meanPredi) * (this.result[i][2] - meanPredi))
      }
      //console.log(prediDivSum)

      return (multSum / (Math.pow(labelDivSum,0.5) * (prediDivSum**0.5))).toFixed(2)
    }
    //return Corr

    this.calClassAcc = function() {
      var classHits = [0,0]

      let goldResult
      if(this.datasetType == "mosi") {
        goldResult = globalGold_mosi
      } else if (this.datasetType == "mosei") {
        goldResult = globalGold_mosei
      }

      for(let i = 0; i < this.result.length; i++) {
        if(this.result[i][3] == goldResult[i][3]) {classHits[0] = classHits[0] + 1}
        if(this.result[i][4] == goldResult[i][4]) {classHits[1] = classHits[1] + 1}
      }

      return [(100 * classHits[0]/this.result.length).toFixed(2), (100 * classHits[1]/this.result.length).toFixed(2)]
    }
    //return [2classAcc, 7classAcc]

    this.calF1 = function() {
      var truePositive = 0
      var falsePositive = 0
      var falseNegative = 0
      var numPositive = 0
      var numNegative = 0

      let goldResult
      if(this.datasetType == "mosi") {
        goldResult = globalGold_mosi
      } else if (this.datasetType == "mosei") {
        goldResult = globalGold_mosei
      }

      for(let i = 0; i < this.result.length; i++) {
        if(this.result[i][3] == 'positive') {
          numPositive = numPositive + 1
          if(goldResult[i][3] == 'positive') {
            truePositive = truePositive + 1
          } else if(goldResult[i][3] == 'negative') {
            falsePositive = falsePositive + 1
          }
        } else if (this.result[i][3] == 'negative'){
          numNegative = numNegative + 1
          if (goldResult[i][3] == 'positive') {
            falseNegative = falseNegative + 1
          }
        }
      }

      //console.log(truePositive,falsePositive,falseNegative);

      var precision = truePositive / (truePositive + falsePositive) * 100
      var recall = truePositive / (truePositive + falseNegative) * 100

      var f1 = 2 * precision * recall / (precision + recall)

      return f1.toFixed(2)
    }
    //return F1

    this.getScores = function() {//return Scores

      var scores = ['', 0.0, 0.0, 0.0, 0.0, 0.0]

      if(this.result) {
        accArray = this.calClassAcc()
        scores = [this.modelName, this.calMAE(), this.calCorr(), accArray[0], accArray[1], this.calF1()]
      }

      return scores
    }
    //return scores[ModelName, MAE, Corr, Acc-2, Acc-7, F1,]
  }

  function Analysis(model, otherModels=[], goldModels=[]) {

    this.model = model
    this.otherModels = otherModels
    this.goldModels = goldModels
    this.canvasList = document.getElementById('canvasList')
    this.vidTable = document.getElementById('videoAcc');
    this.segTable = document.getElementById('segmentAcc');
    this.plotHolder = document.getElementById('plotHolder');
    this.chart_binary_distribution = new Chart()
    this.chart_7class_distribution = new Chart()
    this.chart_segment_plot = new Chart()
    this.chart_segment_plot1 = new Chart()
    this.currentVideo = 0
    this.currentClip = 0

    this.updateGraph = function(){
      //create class accuracy bar-graph
      var analysisDataset2;
      var analysisDataset7;

      if(this.model) {//our model is uploaded
        var ourData = this.model.getClassPop()
        console.log(this.model.modelName + " is being drawn")

        analysisDataset2 = {
          labels: labels2class,
          datasets: [{
            label: 'Gold',
            backgroundColor: 'rgb(122, 99, 132)',
            borderColor: 'rgb(122, 99, 132)',
            data: ourData[0][0],
          },
          {
            label: 'Predicted',
            backgroundColor: 'rgb(255, 99, 132)',
            borderColor: 'rgb(255, 99, 132)',
            data: ourData[0][1],
          }]
        };

        analysisDataset7 = {
          labels: labels7class,
          datasets: [{
            label: 'Gold',
            backgroundColor: 'rgb(122, 99, 132)',
            borderColor: 'rgb(122, 99, 132)',
            data: ourData[1][0],
          },
          {
            label: 'Predicted',
            backgroundColor: 'rgb(255, 99, 132)',
            borderColor: 'rgb(255, 99, 132)',
            data: ourData[1][1],
          }]
        };
      }

      this.canvasList.innerHtml = ""
      this.canvasList.innerHtml = "<div class='canvasHolder'><canvas class='graph' id='graph_class_2'></canvas></div><div class='canvasHolder'><canvas class='graph' id='graph_class_7'></canvas></div>"

      //clear canvas before new drawing
      var graph2 = document.getElementById('graph_class_2').getContext("2d");
      var graph7 = document.getElementById('graph_class_7').getContext("2d");

      //draw chart with new chart instance
      this.chart_binary_distribution.destroy()
      this.chart_binary_distribution = new Chart(graph2, {
        type: 'bar',
        data: analysisDataset2,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              //suggestedMax: 100
            }
          }
        },
        }
      );

      this.chart_7class_distribution.destroy()
      this.chart_7class_distribution = new Chart(graph7, {
        type: 'bar',
        data: analysisDataset7,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              //suggestedMax: 100
            }
          }
        },
        }
      );


    }


    this.updatePbarVideo = function(){//Draw Accuracy Bar of the Videos
      var modelAcc = this.model.getVideoAcc()
      document.getElementById('videoAcc').innerHTML = "<tr id='segName_segAcc'><td></td></tr><tr><td>2 Class</td></tr><tr><td>7 Class</td></tr>"

      //add progess bar in table #videoAcc
      for(let i = 0; i < modelAcc.length; i++) {
        var tblBodyObj = this.vidTable.tBodies[0];
        var newVidTitle = tblBodyObj.rows[0].insertCell(-1);
        var newVidAcc_2 = tblBodyObj.rows[1].insertCell(-1);
        var newVidAcc_7 = tblBodyObj.rows[2].insertCell(-1);

        newVidTitle.innerHTML = '<div class="descript" style="margin-bottom: 2px; font-size: 18px; cursor: pointer;" onclick="selectVideo(this)">' + modelAcc[i][0] + '</div>'
        newVidAcc_2.innerHTML = '<progress value=' + String(modelAcc[i][1]) + ' max="100">'
        newVidAcc_7.innerHTML = '<progress value=' + String(modelAcc[i][2]) + ' max="100">'
      }
    }

    this.updatePbarSegment = function(video_id) {//Draw Progress Bar of a single Segment
      this.segTable.innerHtml = ""
      if(arguments.length == 0) {
        this.segTable.innerHtml = ""
        console.log("No video selected")
        return
      }

      //process this.result via video
      var segHitMap = this.model.getSegmentAcc(video_id)

      var segNumberList = document.getElementById('selectWrapper');
      segNumberList.innerHTML = '';
      for(let i = 0; i < segHitMap[0].length; i++) {
        var tblBodyObj = this.segTable.tBodies[0];
        var newSegTitle = tblBodyObj.rows[0].insertCell(-1);
        var newSegAcc_2 = tblBodyObj.rows[1].insertCell(-1);
        var newSegAcc_7 = tblBodyObj.rows[2].insertCell(-1);


        let tempSegment = document.createElement('div');
        tempSegment.innerText = String(i);
        tempSegment.className = `selectItem item${i}`;
        tempSegment.addEventListener('click', function() {
          selectSegment(this);
          let prev = document.querySelectorAll('.selectWrapper .selectItem.clicked');
          for(var j=0; prev[j]; j++) {
            prev[j].classList.remove('clicked');
          }
          let next = document.querySelectorAll(`.selectWrapper .selectItem.item${i}`);
          for(var j=0; next[j]; j++) {
            next[j].classList.add('clicked');
          }
        });
        segNumberList.appendChild(tempSegment);

        newSegTitle.innerHTML = "<div class='segmentName' onclick=selectSegment(this)>"+ String(i)+"</div>"
        newSegAcc_2.innerHTML = '<progress value=' + String(segHitMap[0][i]*100) + ' max="100">'
        newSegAcc_7.innerHTML = '<progress value=' + String(segHitMap[1][i]*100) + ' max="100">'
      }
      segNumberList.firstChild.click();
    }

    this.updateScatterSegment = function(video_id, segment_id) {
      if(arguments.length == 0) {
        this.plotHolder.innerHtml = ""
        console.log("No video and segment selected")
        return
      }

      console.log("Video and segment selected")
      //get Data
      var selectedSegment = this.model.searchSegment(video_id,segment_id)
      var ourPoint = 0
      if(selectedSegment[0]) {
        ourPoint = selectedSegment[2]
      }

      var otherDatas = [] //[[modelName, predi],[modelName, Predi],[modelName, Predi]]
      for (let i = 0; i < this.otherModels.length; i++) {
        otherDatas.push([this.otherModels[i].modelName, this.otherModels[i].searchSegment(video_id,segment_id)[2]])
      }

      console.log("otherDatas")
      console.log(otherDatas)

      var goldDatas = [] 
      for (let i = 0; i < this.goldModels.length; i++){
        goldDatas.push([this.goldModels[i].modelName, this.goldModels[i].searchSegment(video_id,segment_id)[2]])
      }
      console.log("goldDatas")
      console.log(goldDatas)

      //draw chart
      this.plotHolder.innerHtml = ""
      this.plotHolder.innerHtml = "<canvas class='plot' id='scatter0'></canvas>"
      var scatter0 = document.getElementById('scatter0').getContext("2d");
      // var scatter1 = document.getElementById('scatter1').getContext("2d");

      var segmentPlot = {
        labels: [''],
        datasets: [{
          label: 'gold',
          backgroundColor: 'black',
          borderColor: 'black',
          data: [[goldDatas[1][1]+0.02, goldDatas[1][1]-0.02]],
        },{
          label: otherDatas[0][0],
          backgroundColor: 'rgb(255, 99, 132)',
          borderColor: 'rgb(255, 99, 132)',
          data: [[otherDatas[0][1]+0.02, otherDatas[0][1]-0.02]],
        },{
          label: otherDatas[1][0],
          backgroundColor: 'rgb(255, 99, 66)',
          borderColor: 'rgb(255, 99, 66)',
          data: [[otherDatas[1][1]+0.02, otherDatas[1][1]-0.02]],
        },{
          label: otherDatas[2][0],
          backgroundColor: 'rgb(120, 50, 132)',
          borderColor: 'rgb(120, 50, 132)',
          data: [[otherDatas[2][1]+0.02, otherDatas[2][1]-0.02]],
        },
        {
          label: 'Our',
          backgroundColor: 'rgb(60, 99, 132)',
          borderColor: 'rgb(60, 99, 132)',
          data: [[ourPoint+0.02, ourPoint-0.02]],
        }]
      };
      
      // mosei
      // var segmentPlot1 = {
      //   labels: [''],
      //   datasets: [{
      //     label: otherDatas[3][0],
      //     backgroundColor: 'rgb(255, 99, 132)',
      //     borderColor: 'rgb(255, 99, 132)',
      //     data: [[otherDatas[3][1]+0.02, otherDatas[3][1]-0.02]],
      //   },{
      //     label: 'Our',
      //     backgroundColor: 'rgb(60, 99, 132)',
      //     borderColor: 'rgb(60, 99, 132)',
      //     data: [[ourPoint+0.02, ourPoint-0.02]],
      //   }]
      // }

      console.log(segmentPlot["datasets"])

      this.chart_segment_plot.destroy()
      this.chart_segment_plot = new Chart(scatter0, {
        type: 'bar',
        data: segmentPlot,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          indexAxis: 'y',
          plugins: {
            legend: {
              display: true
            },
            /*
            tooltip: {
              callbacks: {
                label: ctx => data[ctx.datasetIndex]
              }
            }*/
          },
          interaction: {
            mode: 'x',
          },
          scales: {
            y: {
              stacked: true,
              grid: {color:'white'},
            },
            x: {
              max: 3,
              min: -3,
              grid: {
                drawBorder: false,
                color: function(context) {
                  if (context.tick.value > 0) {
                    return '#00ff00';
                  } else if (context.tick.value < 0) {
                    return '#ff0000';
                  }
                  return '#000000';
                },
              },

            }
          }
        }
      });

      // mosei
      // this.chart_segment_plot1.destroy()
      // this.chart_segment_plot1 = new Chart(scatter1, {
      //   type: 'bar',
      //   data: segmentPlot1,
      //   options: {
      //     responsive: true,
      //     maintainAspectRatio: true,
      //     indexAxis: 'y',
      //     plugins: {
      //       legend: {
      //         display: true
      //       },
      //       /*
      //       tooltip: {
      //         callbacks: {
      //           label: ctx => data[ctx.datasetIndex]
      //         }
      //       }*/
      //     },
      //     interaction: {
      //       mode: 'x',
      //     },
      //     scales: {
      //       y: {
      //         stacked: true,
      //         grid: {color:'white'},
      //       },
      //       x: {
      //         max: 3,
      //         min: -3,
      //         grid: {
      //           drawBorder: false,
      //           color: function(context) {
      //             if (context.tick.value > 0) {
      //               return '#00ff00';
      //             } else if (context.tick.value < 0) {
      //               return '#ff0000';
      //             }
      //             return '#000000';
      //           },
      //         },

      //       }
      //     }
      //   }
      // });

    }

    this.updateView = function(video_id) { //Show Video's video, sound, text

    }

    this.changeVideo = function(video_id) {//When video is chosen hilgiht selected video, Update Prgroess bar for every Segment, update View
      //highlight Selected Video

      //create progress bar for every segment
      while(false) {
        this.updatePbarSegment()
      }

      //update View

    }
  }

  var goldTestResult = [["abcd",0,"text1",-0.5,'negative','slightly negative',-0.4,"negative",'slightly negative']
                       ,["abcd",1,"text1",-1.5,'negative','negative',-0.3,"negative",'slightly negative']
                       ,["abcd",2,"text1", 2.5,'positive','very positive',0,'positive',"Neutral"]
                       ,["abcd",3,"text1", 0.5,'positive','slightly positive',0.7,"positive",'slightly positive']
                       ,["abcd",4,"text1",-2.5,'negative','very negative',-2.4,"negative",'very negative']
                       ,["abcd",5,"text1", 0.3,'positive','Neutral',-0.4,"negative",'slightly negative']
                       ,["abcd",6,"text1", 1.0,'positive','positive',1.0,"positive",'positive']];

  var ourTestResult =  [["abcd",0,"text1",-0.5,'negative','slightly negative',-0.4,"negative",'slightly negative']
                       ,["abcd",1,"text1",-1.5,'negative','negative',-0.3,"negative",'slightly negative']
                       ,["abcd",2,"text1", 2.5,'positive','very positive',-0.3,"negative",'slightly negative']
                       ,["abcd",3,"text1", 0.5,'positive','slightly positive',1.7,"positive",'positive']
                       ,["abcd",4,"text1",-2.5,'negative','very negative',-2.4,"negative",'very negative']
                       ,["abcd",5,"text1", 0.3,'positive','Neutral',-0.4,"negative",'slightly negative']
                       ,["abcd",6,"text1", 1.0,'positive','positive',1.0,"positive",'positive']];


  var newGoleTestResult = [["abcd",0,0.33,'positive','Neutral']
                           ["abcd",1,0.33,'positive','Neutral']];
  var newOurTestResult =  [["abcd",0,1.33,'positive','positive']
                           ["abcd",0,0.33,'positive','Neutral']];

  var goldModel = new Model("GOLD", "donghoon", goldTestResult)
  var ourModel = new Model("OUR","notDonghoon",ourTestResult)
  var analysisTest = new Analysis()

  // Construct Gold model list
  let goldModelList = [null, null];

  let xmlhttprequest0 = new XMLHttpRequest();
  xmlhttprequest0.open('GET', 'http://210.107.197.59:80/csv?name=gold&dataset=mosei');
  xmlhttprequest0.onreadystatechange = function() {
    if(this.readyState == 4) {
      let jsonParsed = JSON.parse(xmlhttprequest0.responseText)
      goldModelList[0] = (new Model("Gold","mosei",jsonToResult(jsonParsed,true)))
      globalGold_mosei = jsonToResult(jsonParsed,true)
    }
  }
  xmlhttprequest0.send();

  let xmlhttprequest1 = new XMLHttpRequest();
  xmlhttprequest1.open('GET', 'http://210.107.197.59:80/csv?name=gold&dataset=mosi');
  xmlhttprequest1.onreadystatechange = function() {
    if(this.readyState == 4) {
      let jsonParsed = JSON.parse(xmlhttprequest1.responseText)
      goldModelList[1] = (new Model("Gold","mosi",jsonToResult(jsonParsed,true)))
      globalGold_mosi = jsonToResult(jsonParsed,true);
    }
  }
  xmlhttprequest1.send();

  analysisTest.goldModels = goldModelList


  let xmlhttprequest = new XMLHttpRequest();
  xmlhttprequest.open('GET', 'http://210.107.197.59:80/csv?name=MAG-BERT_mosi_result&dataset=mosi');
  xmlhttprequest.onreadystatechange = function() {
    if(this.readyState == 4) {
      var jsonParsed = JSON.parse(xmlhttprequest.responseText)
      console.log(jsonToResult(jsonParsed,false))

      var modelTest01 = new Model("newTest","mosi",jsonToResult(jsonParsed,false))
      console.log(modelTest01.getScores())
      //console.log(modelTest01.getClassPop())
      console.log(modelTest01.getVideoAcc())

      analysisTest.model = modelTest01
      analysisTest.updateGraph()
      analysisTest.updateGraph()
      analysisTest.updatePbarVideo()
      analysisTest.updatePbarSegment()
      analysisTest.updateScatterSegment("c7UH_rxdZv4",0)


      //var comparisonTest = new Comparison([modelTest01, modelCopy, modelTest01], [modelTest01], [modelTest01, modelCopy, modelTest01])
      //comparisonTest.updateList()
    }
  }
  xmlhttprequest.send();

  // Construct other model list
  let otherModelList = [null, null, null, null];

  let xmlhttprequest2 = new XMLHttpRequest();
  xmlhttprequest2.open('GET', 'http://210.107.197.59:80/csv?name=MAG-BERT_mosi_result&dataset=mosi');
  xmlhttprequest2.onreadystatechange = function(){
    if(this.readyState == 4){
      var jsonParsed = JSON.parse(xmlhttprequest2.responseText)
      otherModelList[0] = new Model("MAG","mosi",jsonToResult(jsonParsed,false));
    }
  }
  xmlhttprequest2.send();

  let xmlhttprequest3 = new XMLHttpRequest();
  xmlhttprequest3.open('GET', 'http://210.107.197.59:80/csv?name=MISA_mosi_result&dataset=mosi');
  xmlhttprequest3.onreadystatechange = function(){
    if(this.readyState == 4){
      var jsonParsed = JSON.parse(xmlhttprequest3.responseText)
      otherModelList[1] = (new Model("MISA","mosi",jsonToResult(jsonParsed,false)));
    }
  }
  xmlhttprequest3.send();

  let xmlhttprequest4 = new XMLHttpRequest();
  xmlhttprequest4.open('GET', 'http://210.107.197.59:80/csv?name=MMIM_mosi_result&dataset=mosi');
  xmlhttprequest4.onreadystatechange = function(){
    if(this.readyState == 4){
      var jsonParsed = JSON.parse(xmlhttprequest4.responseText)
      otherModelList[2] = (new Model("MMIM","mosi",jsonToResult(jsonParsed,false)));
    }
  }
  xmlhttprequest4.send();

  let xmlhttprequest5 = new XMLHttpRequest();
  xmlhttprequest5.open('GET', 'http://210.107.197.59:80/csv?name=MAG-BERT_mosei_result&dataset=mosei');
  xmlhttprequest5.onreadystatechange = function(){
    if(this.readyState == 4){
      var jsonParsed = JSON.parse(xmlhttprequest5.responseText)
      otherModelList[3] = (new Model("MAG","mosei",jsonToResult(jsonParsed,false)));
    }
  }
  xmlhttprequest5.send();

  // otherModels = [[model_name, model_dataset, model_file], [model_name, model_dataset, model_file]]
  analysisTest.otherModels = otherModelList


  //interaction
  function uploadResult() {
    document.getElementById("inputModelFile")

    var uploadingModel = new Model()
    console.log()
    //uploadingModel.uploadModel(document.getElementById("inputModelName").value,document.getElementById("inputModelUrl").value,[]);

  }

  function selectVideo(videoId) { //update Segment Hit section when we click video_id in Video Accuracy section
    //change Segment Hit
    analysisTest.updatePbarSegment(videoId.innerText)

    //change segmentVidName
    var segmentTitle = document.getElementById('segmentVidName')
    segmentTitle.innerText = videoId.innerText
  }

  function selectSegment(segmentId) { //update Segment Hit section when we click video_id in Video Accuracy section
    //change Scatter Plot
    let segmentTableVideo = document.getElementById('segmentVidName').innerText
    if(segmentTableVideo == "no video selected") {
      console.log('no video or segment selected selected')
      return
    }
    analysisTest.updateScatterSegment(segmentTableVideo, segmentId.innerText)
  }

  function selectModel(model_name, model_dataset, model_file) {//after selecting a model, draw distribution chart, video accuracy table,
    analysisTest.model = new Model(model_name, model_dataset ,jsonToResult(model_file))
    analysisTest.updateGraph()
    analysisTest.updatePbarVideo()
    analysisTest.updatePbarSegment()  //reset
    analysisTest.updateScatterSegment() //reset
  }

  function registerCompModel(compModelList) { //[[model_name, model_dataset, model_file], [model_name, model_dataset, model_file]]
    let otherModelList = []
    for(let i = 0; i < compModelList.length; i++) {
      otherModelList.push(new Model(compModelList[i][0], compModelList[i][1], compModelList[i][2]))
    }
    analysisTest.otherModels = otherModelList
  }

    </script>
  </body>
</html>
