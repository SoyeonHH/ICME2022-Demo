<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="/style/common.css" type="text/css">
    <link rel="stylesheet" href="./style/analysis.css" type="text/css">
  </head>
  <body>
    <div class="header">
      <div class="header-leading">
        <span style="color: green">MM</span><span style="color: red">S</span><span style="color: purple">A</span>
      </div>
      <div class="header-github"><img src="./image/github.png" /></div>
      <div class="header-item">Comparision</div>
      <div class="header-item selected">Analysis</div>
      <a href="http://localhost:3000"><div class="header-item">View</div></a>
    </div>
    <div class="section">
      <h1>Analysis</h1>
      <div id="workspace">
        <h2>Upload Your Results</h2>
        <table id = "uploadTable">
          <tr>
            <td>Model Name</td>
            <td><input type="text" id="inputModelName"></input></td>
          </tr>
          <tr>
            <td>Link</td>
            <td><input type="url"  id="inputModelUrl"></input></td>
          </tr>
        </table>
        <form id="csv-form" enctype="multipart/form-data">
          result csv file
          <input type="file" id="inputModelFile" accept=".csv"></input>
          <button type="button" id="uploadButton">upload</button>
        </form>



      </div>
      <div id="barGraph">
        <h2>Gold vs Our Accuracy</h2>
        <div id="canvasList">
          <canvas class="graph" id='graph_class_2'></canvas>
          <canvas class="graph" id='graph_class_7'></canvas>
        </div>
      </div>
      <div id="p-barVideos">
        <h2>Video Accuracy</h2>
        <table id="videoAcc">
          <tr id="vidName_vidAcc">
            <td></td>
            <td>video0</td>
            <td>video1</td>
            <td>video2</td>
          </tr>
          <tr>
            <td>2 Class</td>
            <td><progress value='70' max='100'></progress></td>
            <td><progress value='50' max='100'></progress></td>
            <td><progress value='40' max='100'></progress></td>
          </tr>
          <tr>
            <td>7 Class</td>
            <td><progress value='40' max='100'></progress></td>
            <td><progress value='70' max='100'></progress></td>
            <td><progress value='60' max='100'></progress></td>
          </tr>
        </table>
      </div>
      <div id="p-barSengment">
        <h2>Segment Hit</h2>
        <h3>Video_0<h3>
        <table id="segmentAcc">
          <tr id="segName_segAcc">
            <td></td>
            <td>id_0</td>
            <td>id_1</td>
            <td>id_2</td>
          </tr>
          <tr>
            <td>2 Class</td>
            <td><progress value='100' max='100'></progress></td>
            <td><progress value='0' max='100'></progress></td>
            <td><progress value='100' max='100'></progress></td>
          </tr>
          <tr>
            <td>7 Class</td>
            <td><progress value='0' max='100'></progress></td>
            <td><progress value='0' max='100'></progress></td>
            <td><progress value='100' max='100'></progress></td>
          </tr>
        </table>
      </div>
      <div id="viewSegment">
        <h2>View Segment</h2>
        <h3>Video_0 id_0</h3>
      </div>
      <div id="compSegment">
        <h2>Comparison</h2>
        <table id="compTable">
          <tr>
            <th>Model</th>
            <th>MAE</th>
            <th>Corr</th>
            <th>Accuracy 2-Class</th>
            <th>Accuracy 7-Class</th>
            <th>F1</th>
          </tr>

        </table>
      </div>
    </div>

    <div class="footer">
      <div class="footer-content">
        <div class="footer-title">
          <span style="color: green">M</span>ulti<span style="color: green">M</span>odal <span style="color: red">S</span>entiment <span style="color: purple">A</span>nalysis
        </div>
        <div class="footer-info">
          <div><a href="https://sites.google.com/view/iknow-lab">
            <svg xmlns="http://www.w3.org/2000/svg" width="10px" height="10px" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 9v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9"/><path d="M9 22V12h6v10M2 10.6L12 2l10 8.6"/></svg>
            iKnow Lab Ajou Univ.</a></div>
          <div>&copy; Soyeon.H</div>
          <div><a href="mailto:sodus1102@ajou.ac.kr">
            <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width='10px' height='10px'><path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z"/></svg>
            sodus1102 at ajou.ac.kr</a></div>
        </div>
      </div>
    </div>

    <script type="text/javascript" src="./script/csv.js"></script>
    <script type="text/javascript" src="./script/chart.js-3.7.1/package/dist/chart.js"></script>
    <script>
  const labels2class = [
    'Negative',
    'Positive'
  ]
  const labels7class = [
    "Very Negative",
    "Negative",
    "Slightly Negative",
    "Neutral",
    "Slightly Positive",
    "Positive",
    "Very Positive",
  ]

  const config = {
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          suggestedMax: 100
        }
      }
    },
  };
  /*
  var reader = new FileReader()
  reader.onload = function(progressEvent) {
    var readResult = []
    var lines = this.result.split(/\r\n|\n/)
    lines.shift
    for(var i = 0; i < lines.length; i++) {
        readResult.push(lines[i].split(','))
    }
    return readResult
  }
  */


  function Model(modelName, publisher, result) {
    this.modelName = modelName
    this.publisher = publisher
    this.result = result //result on every segment

    this.uploadModel = function(modelName, publisher, inputFile) {
      //update attributes
      this.modelName = modelName
      this.publisher = publisher

      //process input file and make this.result
      var fileReader = new FileReader()
      fileReader.onload = function() {
        var readResult = []
        var lines = this.result.split(/\r\n|\n/)
        lines.shift //remove header
        for(var i = 0; i < lines.length; i++) {
            readResult.push(lines[i].split(','))
        }
        return readResult

      }

      console.log()
      this.result = []


    }

    this.getClassAcc = function() {//return class accuracy from model's result file
      var returnAcc2 = [0,0]
      var returnAcc7 = [0,0,0,0,0,0,0]

      if(this.result) {//result exist.
        //2 class result
        var cnt2class = [0,0]
        var hit2class = [0,0]

        for (var i = 0; i < this.result.length; i++) {
          var j = -1
          switch(result[i][4]) {
            case 'negative'         : j = 0; break;
            case 'positive'         : j = 1; break;
            default : break; //err uknown class
          }

          cnt2class[j] = cnt2class[j] + 1
          if(result[i][4] == result[i][7]) {//hit
            hit2class[j] = hit2class[j] + 1
          }
        }

        for (var i = 0; i <2; i++) {
          returnAcc2[i] = hit2class[i] / cnt2class[i] * 100
        }


        var cnt7class = [0,0,0,0,0,0,0]
        var hit7class = [0,0,0,0,0,0,0]

        for (var i = 0; i < this.result.length; i++) {
          var j = -1
          switch(result[i][5]) {
            case 'very negative'    : j = 0; break;
            case 'negative'         : j = 1; break;
            case 'slightly negative': j = 2; break;
            case 'neutral'          : j = 3; break;
            case 'slightly positive': j = 4; break;
            case 'positive'         : j = 5; break;
            case 'very positive'    : j = 6; break;
            default : break; //err uknown class
          }

          cnt7class[j] = cnt7class[j] + 1
          if(result[i][5] == result[i][8]) {
            hit7class[j] = hit7class[j] + 1
          }
        }

        for (var i = 0; i <7; i++) {
          returnAcc7[i] = hit7class[i] / cnt7class[i] * 100
        }
      }

      return [returnAcc2, returnAcc7]
    }
    //return [returnAcc2, returnAcc7]
    //returnAcc2, list ofaccuracy of each 2 classes
    //returnAcc7, list ofaccuracy of each 7 classes

    this.getVideoAcc = function() {//return video accuracy from model's result file
      var vidName = []

      var cntVid2 = []
      var hitVid2 = []
      var cntVid7 = []
      var hitVid7 = []

      var accVid2 = []
      var accVid7 = []

      if(this.result) {//when result exist count cnt and hit via video
        var tempVidName = ''
        var index = 0
        var saveIndex = 0

        tempVidName = this.result[index][0]
        vidName.push(tempVidName)
        cntVid2.push(0)
        hitVid2.push(0)
        cntVid7.push(0)
        hitVid7.push(0)

        for(var i = 0; i < this.result.length; i++) {
          if(vidName[saveIndex] != this.result[i][0]) {//new video name
            saveIndex = saveIndex + 1
            vidName.push(this.result[i][0])
            cntVid2.push(0)
            hitVid2.push(0)
            cntVid7.push(0)
            hitVid7.push(0)
          }

          cntVid2[saveIndex] = cntVid2[saveIndex] + 1
          cntVid7[saveIndex] = cntVid7[saveIndex] + 1

          if(this.result[i][4] == this.result[i][7]) {
            hitVid2[saveIndex] = hitVid2[saveIndex] + 1
          }
          if(this.result[i][5] == this.result[i][8]) {
            hitVid7[saveIndex] = hitVid7[saveIndex] + 1
          }
        }
      }

      for(var i = 0; i < cntVid2.length; i++) {//calculate acc via video with hit and cnt
        accVid2.push(hitVid2[i]/cntVid2[i]*100)
        accVid7.push(hitVid7[i]/cntVid7[i]*100)
      }

      var returning = []
      for(var i = 0; i < cntVid2.length; i++) {
        returning.push([vidName[i],accVid2[i],accVid7[i]])
      }
      return returning
    }
    //return [vidName, accVid2, accVid7]
    //vidName, list of video_id
    //accVid2, list ofaccuracy of video in 2 class
    //accVid7, list ofaccuracy of video in 7 class

    this.getSegmentAcc = function(videoId) {//return hit map of single segmentAcc
      var hitMap2 = []
      var hitMap7 = []

      if(this.result) {
        for(var i = 0; i < this.result.length; i++) {
          //console.log(videoId)
          //console.log(this.result[i][0])
          if(this.result[i][0] == videoId) {//the correct video id
            if(this.result[i][4] == this.result[i][7]) {//hit in 2 class
              hitMap2.push(1)
            } else hitMap2.push(0) //miss in 2 class

            if(this.result[i][5] == this.result[i][8]) {//hit in 7 class
              hitMap7.push(1)
            } else hitMap7.push(0) //miss in 7 class
          }
        }
      }
      return [hitMap2, hitMap7]
    }
    //return [hitMap2, hitMap7]
    //hitMap2, linear Hit map of video in 2 class
    //hitMap2, linear Hit map of video in 7 class

    this.calMAE = function() {
      var sumErr = 0

      for(var i = 0; i< this.result.length; i++) { // | predi - labeli |
        var err = this.result[i][6] - this.result[i][3]
        if(err > 0 ) { sumErr = sumErr + err}
        else {sumErr = sumErr - err}
      }

      if(this.result.length > 0) {
        return sumErr / this.result.length
      } else {
        return -1
      }
    }
    //return MAE

    this.calCorr = function() {
      var meanLabel = 0
      var meanPredi = 0

      var multSum = 0
      for (var i = 0; i < this.result.length; i++) {
        multSum = multSum + (this.result[i][3] - meanLabel) * (this.result[i][6] - meanPredi)
      }

      var labelDivSum = 0
      for (var i = 0; i < this.result.length; i++) {
        labelDivSum = labelDivSum + (this.result[i][3] - meanLabel) * (this.result[i][3] - meanLabel)
      }

      var prediDivSum = 0
      for (var i = 0; i < this.result.length; i++) {
        prediDivSum = prediDivSum + (this.result[i][6] - meanPredi) * (this.result[i][6] - meanPredi)
      }

      return multSum / (labelDivSum^0.5 * prediDivSum^0.5)
    }
    //return Corr

    this.calClassAcc = function() {

      var classHits = [0,0]

      for(var i = 0; i < this.result.length; i++) {
        if(this.result[i][4] == this.result[i][7]) {classHits[0] = classHits[0] + 1}
        if(this.result[i][5] == this.result[i][8]) {classHits[1] = classHits[1] + 1}
      }

      return [100 * classHits[0]/this.result.length, 100 * classHits[1]/this.result.length]
    }
    //return [2classAcc, 7classAcc]

    this.calF1 = function() {
      var truePositive = 0
      var flasePositive = 0
      var falseNegative = 0

      for(var i = 0; i < this.result.length; i++) {
        if(this.result[i][7] == 'positive') {
          if(this.result[i][4] == 'positive') {
            truePositive = truePositive + 1
          } else if(this.result[i][4] == 'negative') {
            flasePositive = flasePositive + 1
          }
        } else if (this.result[i][7] == 'negative' && this.result[i][4] == 'positive') {
          falseNegative = falseNegative + 1
        }
      }

      var precision = truePositive / (truePositive + falsePositive)
      var recall = truePositive / (truePostivie + falseNegative)

      var f1 = 2 * precision * recall / (precision + recall)

      return f1
    }
    //return F1

    this.getScores = function() {//return Scores

      var scores = ['', 0.0, 0.0, 0.0, 0.0, 0.0]

      if(this.result) {
        accArray = this.calClassAcc()
        scores = [this.modelName, this.calMAE(), this.calCorr(), accArray[0], accArray[1], this.calF1()]
      }

      return scores


    }
    //return scores[ModelName, MAE, Corr, Acc-2, Acc-7, F1,]
  }

  function Analysis(goldModel, model) {

    this.goldModel = goldModel
    this.model = model
    this.graph2 = document.getElementById('graph_class_2').getContext("2d");
    this.graph7 = document.getElementById('graph_class_7').getContext("2d");
    this.vidTable = document.getElementById('videoAcc');
    this.segTable = document.getElementById('segmentAcc');
    this.currentVideo = 0
    this.currentClip = 0

    this.updateGraph = function(){
      //create class accuracy bar-graph
      var analysisDataset2;
      var analysisDataset7;

      if(this.model) {//our model is uploaded
        var goldData = this.goldModel.getClassAcc()
        var ourData = this.model.getClassAcc()

        analysisDataset2 = {
          labels: labels2class,
          datasets: [{
            label: 'Gold',
            backgroundColor: 'rgb(255, 99, 132)',
            borderColor: 'rgb(255, 99, 132)',
            data: goldData[0],
          },
          {
            label: 'Our',
            backgroundColor: 'rgb(122, 99, 132)',
            borderColor: 'rgb(122, 99, 132)',
            data: ourData[0],
          }]
        };

        analysisDataset7 = {
          labels: labels7class,
          datasets: [{
            label: 'Gold',
            backgroundColor: 'rgb(255, 99, 132)',
            borderColor: 'rgb(255, 99, 132)',
            data: goldData[1],
          },
          {
            label: 'Our',
            backgroundColor: 'rgb(122, 99, 132)',
            borderColor: 'rgb(122, 99, 132)',
            data: ourData[1],
          }]
        };

      } else {//no model has been uploaded show only gold Model results
        var goldData = this.goldModel.getClassAcc()

        analysisDataset2 = {
          labels: labels2class,
          datasets: [{
            label: 'Gold',
            backgroundColor: 'rgb(255, 99, 132)',
            borderColor: 'rgb(255, 99, 132)',
            data: goldData[0],
          }]
        };

        analysisDataset7 = {
          labels: labels7class,
          datasets: [{
            label: 'Gold',
            backgroundColor: 'rgb(255, 99, 132)',
            borderColor: 'rgb(255, 99, 132)',
            data: goldData[1],
          }]
        };
      }

      //clear canvas before new drawing
      this.graph2.clearRect(0,0,50,50)
      this.graph7.clearRect(0,0,50,50)

      //draw chart with new chart instance
      var chart0 = new Chart(this.graph2, {
        type: 'bar',
        data: analysisDataset2,
        options: {
          responsive: false,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              suggestedMax: 100
            }
          }
        },
        }
      );

      console.log(chart0)

      var chart1 = new Chart(this.graph7, {
        type: 'bar',
        data: analysisDataset7,
        options: {
          responsive: false,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              suggestedMax: 100
            }
          }
        },
        }
      );

      console.log(chart1)

    }

    this.updatePbarVideo = function(){//Draw Accuracy Bar of the Videos
      var modelAcc = this.model.getVideoAcc()
      console.log(modelAcc)

      //add progess bar in table #videoAcc
      for(var i = 0; i < modelAcc.length; i++) {
        var tblBodyObj = this.vidTable.tBodies[0];
        var newVidTitle = tblBodyObj.rows[0].insertCell(-1);
        var newVidAcc_2 = tblBodyObj.rows[1].insertCell(-1);
        var newVidAcc_7 = tblBodyObj.rows[2].insertCell(-1);

        newVidTitle.innerHTML = modelAcc[i][0]
        newVidAcc_2.innerHTML = '<progress value=' + String(modelAcc[i][1]) + ' max="100">'
        newVidAcc_7.innerHTML = '<progress value=' + String(modelAcc[i][2]) + ' max="100">'
      }


    }

    this.updatePbarSegment = function(video_id) {//Draw Progress Bar of a single Segment
      //process this.result via video
      var segHitMap = this.model.getSegmentAcc(video_id)
      console.log(segHitMap)
      //create per segment progress bar

      for(var i = 0; i < segHitMap[0].length; i++) {
        var tblBodyObj = this.segTable.tBodies[0];
        var newSegTitle = tblBodyObj.rows[0].insertCell(-1);
        var newSegAcc_2 = tblBodyObj.rows[1].insertCell(-1);
        var newSegAcc_7 = tblBodyObj.rows[2].insertCell(-1);

        newSegTitle.innerHTML = String(i)
        newSegAcc_2.innerHTML = '<progress value=' + String(segHitMap[0][i]*100) + ' max="100">'
        newSegAcc_7.innerHTML = '<progress value=' + String(segHitMap[1][i]*100) + ' max="100">'
      }
    }

    this.updateView = function(video_id) { //Show Video's video, sound, text

    }

    this.changeVideo = function(video_id) {//When video is chosen hilgiht selected video, Update Prgroess bar for every Segment, update View
      //highlight Selected Video

      //create progress bar for every segment
      while(false) {
        this.updatePbarSegment()
      }

      //update View

    }
  }

  function Comparison(goldModels, ourModels, modelList) {
    this.goldModels = goldModels
    this.ourModels = ourModels
    this.models = modelList
    this.compTable = document.getElementById('compTable')

    this.updateTop() = function() {
      for(var i = 0; i < this.goldModels.length; i++) {
        var lastRow = this.compTable.rows.length;
        // if there's no header row in the table, then iteration = lastRow + 1
        var iteration = lastRow;
        var row = this.compTable.insertRow(lastRow);

        var scores = this.goldModels[i].getScores()

        var cell_model = row.insertCell(0);
        cell_model.innerHTML = '<div class="compTop">' + this.goldModels[i].modelName + '</div>'
        var cell_MAE = row.insertCell(1);
        cell_MAE.innerHTML = '<div class="compTop">' + String(scores[0]) + '</div>'
        var cell_Corr = row.insertCell(2);
        cell_Corr.innerHTML = '<div class="compTop">' + String(scores[1]) + '</div>'
        var cell_Acc2  = row.insertCell(3);
        cell_Acc2.innerHTML = '<div class="compTop">' + String(scores[2]) + '</div>'
        var cell_Acc7 = row.insertCell(4);
        cell_Acc7.innerHTML = '<div class="compTop">' + String(scores[3]) + '</div>'
        var cell_F1 = row.insertCell(5);
        cell_F1.innerHTML = '<div class="compTop">' + String(scores[4]) + '</div>'
      }

      for(var i = 0; i < this.ourModels.length; i++) {
        var lastRow = this.compTable.rows.length;
        // if there's no header row in the table, then iteration = lastRow + 1
        var iteration = lastRow;
        var row = this.compTable.insertRow(lastRow);

        var scores = this.ourModels[i].getScores()

        var cell_model = row.insertCell(0);
        cell_model.innerHTML = '<div class="compOur">'+ this.ourModels[i].modelName + '</div>'
        var cell_MAE = row.insertCell(1);
        cell_MAE.innerHTML = '<div class="compOur">' + String(scores[0]) + '</div>'
        var cell_Corr = row.insertCell(2);
        cell_Corr.innerHTML = '<div class="compOur">' + String(scores[1]) + '</div>'
        var cell_Acc2  = row.insertCell(3);
        cell_Acc2.innerHTML = '<div class="compOur">' + String(scores[2]) + '</div>'
        var cell_Acc7 = row.insertCell(4);
        cell_Acc7.innerHTML = '<div class="compOur">' + String(scores[3]) + '</div>'
        var cell_F1 = row.insertCell(5);
        cell_F1.innerHTML = '<div class="compOur">' + String(scores[4]) + '</div>'
      }
    }

    this.updateList(alignRule) = function(){
      this.models.sort(alignRule)
      for(var i = 0; i < this.models.length; i++) {
        var lastRow = this.compTable.rows.length;
        // if there's no header row in the table, then iteration = lastRow + 1
        var iteration = lastRow;
        var row = this.compTable.insertRow(lastRow);

        var scores = this.models[i].getScores()

        var cell_model = row.insertCell(0);
        cell_model.innerHTML = this.models[i].modelName
        var cell_MAE = row.insertCell(1);
        cell_MAE.innerHTML = String(scores[0])
        var cell_Corr = row.insertCell(2);
        cell_Corr.innerHTML = String(scores[1])
        var cell_Acc2  = row.insertCell(3);
        cell_Acc2.innerHTML = String(scores[2])
        var cell_Acc7 = row.insertCell(4);
        cell_Acc7.innerHTML = String(scores[3])
        var cell_F1 = row.insertCell(5);
        cell_F1.innerHTML = String(scores[4])
      }
    }

    this.drawCompTable(alignRule) = function() {
      this.updateTop()
      this.updateList(alignRule)
    }//use this to draw Comparison table
  }


  var goldTestResult = [["abcd",0,"text1",-0.5,'negative','slightly negative',-0.4,"negative",'slightly negative']
                       ,["abcd",1,"text1",-1.5,'negative','negative',-0.3,"negative",'slightly negative']
                       ,["abcd",2,"text1", 2.5,'positive','very positive',0,'positive',"neutral"]
                       ,["abcd",3,"text1", 0.5,'positive','slightly positive',0.7,"positive",'slightly positive']
                       ,["abcd",4,"text1",-2.5,'negative','very negative',-2.4,"negative",'very negative']
                       ,["abcd",5,"text1", 0.3,'positive','neutral',-0.4,"negative",'slightly negative']
                       ,["abcd",6,"text1", 1.0,'positive','positive',1.0,"positive",'positive']];

  var ourTestResult =  [["abcd",0,"text1",-0.5,'negative','slightly negative',-0.4,"negative",'slightly negative']
                       ,["abcd",1,"text1",-1.5,'negative','negative',-0.3,"negative",'slightly negative']
                       ,["abcd",2,"text1", 2.5,'positive','very positive',-0.3,"negative",'slightly negative']
                       ,["abcd",3,"text1", 0.5,'positive','slightly positive',1.7,"positive",'positive']
                       ,["abcd",4,"text1",-2.5,'negative','very negative',-2.4,"negative",'very negative']
                       ,["abcd",5,"text1", 0.3,'positive','neutral',-0.4,"negative",'slightly negative']
                       ,["abcd",6,"text1", 1.0,'positive','positive',1.0,"positive",'positive']];



  var goldModel = new Model("GOLD", "donghoon", goldTestResult)
  var ourModel = new Model("OUR","notDonghoon",ourTestResult)
  var analysis = new Analysis(goldModel, ourModel)



  analysis.updateGraph()
  analysis.updatePbarVideo()
  analysis.updatePbarSegment('abcd')

  //interaction
  function uploadResult() {
    document.getElementById("inputModelFile")

    var uploadingModel = new Model()
    console.log()
    //uploadingModel.uploadModel(document.getElementById("inputModelName").value,document.getElementById("inputModelUrl").value,[]);

  }


  </script>
  </body>
</html>
